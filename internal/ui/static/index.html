<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>logship</title>
<style>
:root { color-scheme: light dark; --bg:#0b0b0f; --fg:#eaeaea; --mut:#a0a0a0; --card:#15151b; --acc:#5b9cff }
body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
header{padding:16px 20px;border-bottom:1px solid #222;display:flex;gap:16px;align-items:center}
h1{font-size:16px;margin:0}
main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
.card{background:var(--card);border:1px solid #222;border-radius:12px;padding:16px}
.grid{display:grid;gap:12px}
.stats{display:flex;gap:12px}
.stat{flex:1;background:#0f0f15;border:1px solid #222;border-radius:10px;padding:12px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #222;vertical-align:top}
input,button,select{background:#0f0f15;border:1px solid #333;color:var(--fg);padding:8px;border-radius:8px}
button{cursor:pointer}
small{color:var(--mut)}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid #333;background:#101018}
.level-info{color:#9cdcfe}.level-warn{color:#f7c07a}.level-error{color:#f7768e}
</style>
</head>
<body>
<header>
  <h1>logship</h1>
  <small id="health">checking…</small>
</header>
<main>
  <section class="card grid">
    <div class="stats">
      <div class="stat"><div>Ingested</div><div id="ingested" style="font-weight:700;font-size:20px">0</div></div>
      <div class="stat"><div>Dropped</div><div id="dropped" style="font-weight:700;font-size:20px">0</div></div>
      <div class="stat"><div>Levels</div><div id="levels" style="font-family:monospace"></div></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="search" placeholder="search message…"/>
      <select id="level">
        <option value="">all levels</option>
        <option>info</option><option>warn</option><option>error</option><option>debug</option>
      </select>
      <button id="refresh">Refresh</button>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">Recent logs</h3>
    <table id="logs"><thead><tr><th>ts</th><th>host</th><th>level</th><th>message</th><th>src</th></tr></thead><tbody></tbody></table>
  </section>

  <section class="card">
    <h3 style="margin-top:0">Last 100 dropped</h3>
    <table id="drops"><thead><tr><th>ts</th><th>rule</th><th>message</th><th>src</th></tr></thead><tbody></tbody></table>
  </section>

  <section class="card">
    <h3 style="margin-top:0">Rules</h3>
    <form id="ruleForm" style="display:flex;gap:8px;flex-wrap:wrap">
      <input name="name" placeholder="name"/>
      <select name="action"><option>drop</option><option>keep</option></select>
      <input name="pattern" placeholder="regex pattern"/>
      <button type="submit">Add rule</button>
      <span id="ruleMsg"></span>
    </form>
    <ul id="rules" style="margin-top:8px"></ul>
    <div style="margin-top:8px;display:flex;gap:8px">
      <input id="testMsg" placeholder="test message…"/>
      <button id="testBtn">Test</button>
      <span id="testRes"></span>
    </div>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
async function api(p, opt){ const r=await fetch(p,opt); if(!r.ok) throw new Error(await r.text()); return r.json() }
async function loadHealth(){ try{ await api('/api/health'); $('#health').textContent='OK'; }catch{ $('#health').textContent='unreachable'; } }
async function loadStats(){ const s=await api('/api/stats'); ingested.textContent=s.ingested; dropped.textContent=s.dropped; levels.textContent=JSON.stringify(s.levels) }
function esc(s){ return s==null?'':String(s) }
function levelClass(l){ l=(l||'').toLowerCase(); if(l==='error')return'level-error'; if(l==='warn')return'level-warn'; if(l==='info')return'level-info'; return '' }
async function loadLogs(){
  const q=new URLSearchParams({limit:'100'});
  const level=document.getElementById('level').value; if(level) q.set('level',level);
  const search=document.getElementById('search').value; if(search) q.set('search',search);
  const data=await api('/api/events?'+q.toString());
  const tbody=document.querySelector('#logs tbody'); tbody.innerHTML='';
  for(const e of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><small>${esc(e.ts)}</small></td><td>${esc(e.host)}</td><td class="${levelClass(e.level)}">${esc(e.level)}</td><td>${esc(e.message)}</td><td><small class="badge">${esc(e.source_ip)}</small></td>`;
    tbody.appendChild(tr);
  }
}
async function loadDrops(){
  const data=await api('/api/events?dropped=true&limit=100');
  const tbody=document.querySelector('#drops tbody'); tbody.innerHTML='';
  for(const e of data){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><small>${esc(e.ts)}</small></td><td><small class="badge">${esc(e.rule_name)}</small></td><td>${esc(e.message)}</td><td><small class="badge">${esc(e.source_ip)}</small></td>`;
    tbody.appendChild(tr);
  }
}
async function loadRules(){
  const rl=await api('/api/rules'); const ul=document.getElementById('rules'); ul.innerHTML='';
  for(const r of rl){ const li=document.createElement('li'); li.textContent=`${r.name} — ${r.action} / ${r.pattern}`; ul.appendChild(li); }
}
document.getElementById('refresh').onclick=()=>Promise.all([loadStats(),loadLogs(),loadDrops()]);
document.getElementById('ruleForm').onsubmit=async(e)=>{
  e.preventDefault(); const f=new FormData(e.target);
  try{ await api('/api/rules',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({name:f.get('name'),action:f.get('action'),pattern:f.get('pattern')})}); ruleMsg.textContent='saved'; await loadRules(); }
  catch(err){ ruleMsg.textContent='error: '+err.message }
};
document.getElementById('testBtn').onclick=async()=>{ const msg=document.getElementById('testMsg').value||''; const r=await api('/api/rules/test',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({message:msg})}); testRes.textContent=r.drop?`DROP by "${r.rule||'rule'}"`:'keep' };
(async function(){ await loadHealth(); await Promise.all([loadStats(),loadLogs(),loadDrops(),loadRules()]); setInterval(loadStats,5000); })();
</script>
</body>
</html>
